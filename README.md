# ws_ft_cd
web service using [fastText](https://github.com/facebookresearch/fastText) to calculate the cosine distance between two texts in Russian

## Содержание

* [Что может](#Что-может)
* [Что используется для работы](#Что-используется-для-работы)
* [Инструкций по установке](#Инструкций-по-установке)
   * [Установка fastText](#Установка-fastText)
   * [Установка и настойка PostgreSQL](#Установка-и-настойка-PostgreSQL)
   * [Создание Базы данных и таблицы](#Создание-Базы-данных-и-таблицы)
   * [Установка Docker и Docker Compose](#Установка-Docker-и-Docker-Compose)
* [Настройка Docker](#Настройка-Docker)
   * [Хранение модели и подключение Volume](#Хранение-модели-и-подключение-Volume)
   * [Настройка Dockerfile](#Настройка-Dockerfile)
* [Настройка web-сервиса](#Настройка-web-сервиса)
* [Запуск и использование](#Запуск-и-использование)
   * [Примеры curl запросов](#Примеры-curl-запросов)

## Что может

* "/"
   * GET - выдается html страница с формой: два textarea (text1, text2) и кнопка потверждения.
   * POST - При нажатии на кнопку вычисляется косинусное расстояние между текстами (text1, text2), производится запись в базу данных, пользователю выдается значение.
* "/history" выдается html страница, на которой отображаются (с пагинацией) уже сделанные ранее запросы и их косинусные расстояния.
* "/similarities"
   * GET - выдает список с пагинацией уже сделанных ранее запросов косинусных расстояний в виде json.
   * POST - создает запрос на проверку косинусного расстояния, производится запись в базу данных, в ответ приходит созданный объект в виде json.
* "/similarities/<similarity_id>"
   * GET - выдает запрос косинусного расстояния с similarity_id в виде json.
   * PUT - редактирование запроса косинусного расстояния с <similarity_id>: text1, text2 - новое расстояние высчитывается, в ответ приходит измененный объект в виде json, новый запрос записывается в базу данных на позицию <similarity_id>
   * DELETE - удаление запроса косинусного расстояния с <similarity_id>. Возвращает сообщение о успешно выполненной операции

## Что используется для работы

* Python3
   * Flask
   * numpy
   * scipy
   * psycopg2
   * peewee
* PostgreSQL
* Docker
* [fastText](https://github.com/facebookresearch/fastText)
* [Модели для русского языка](http://docs.deeppavlov.ai/en/master/intro/pretrained_vectors.html#id2)

## Инструкций по установке

Проект создавался и тестировался на ОС Ubuntu 16.04 x64 и все команды представлены для неё.
Клонируем данный репозиторий и переходим в него
```
$ git clone https://github.com/ismagilovtr7118/ws_ft_cd.git
$ cd ws_ft_cd/
```

### Установка fastText

Описан в зависимостях, устанавливается автоматически.

### Установка и настойка PostgreSQL

Собирается docker-compose из [официального образа postgresql на docker hub] 

### Создание Базы данных и таблицы

Создание базы данных описано в файле db/init.sql исполняемом при создании образа.

### Установка Docker и Docker Compose

Docker и Docker Compose не нуждаются в такой подробной настройке по этому я не буду их так подробно описывать, стандартные руководства от разработчиков являются достаточными:
[Установка Docker Community](https://docs.docker.com/install/linux/docker-ce/ubuntu/)
[Установка Docker Compose](https://docs.docker.com/compose/install/)

## Настройка Docker

Теперь, когда есть всё необходимое для запуска, необходимо настроить Docker.
Все дальнейшие настройки в файлах проекта записаны для моей инсталяции и могут не заработать у вас при бездумном копировании.
В папке с проектом в настоящий момент должна была получиться следующая структура:
```
~/ws_ft_cd$ ll -h
./
../
db/
docker-compose.yml
.git/
project/
README.md
```
Здесь нас интересует файл docker-compose.yml
В данном проекте разворачивается 2 сервиса: web и db.
Для web сервиса стоит обратить внимание на раздел environment там указано имя используемой вами модели:
```
- MODELNAME='model_FT.bin'
```
MODELNAME - имя(не путь,а именно имя файла) модели, используемой для векторизации текста. Я использовал модель обученную на Twitter взятую [отсюда](http://docs.deeppavlov.ai/en/master/features/pretrained_vectors.html#id2).
В вашем случае она будет называться 'ft_native_300_ru_twitter_nltk_word_tokenize.bin'
В моём случае выбор модели основывался на её весе, т.к. я был ограничен в размерах оперативной памяти. Как вы могли заметить модель я переименовал. Просто для удобства.
Остальные параметры можно оставить без изменений.
Для db указаны пользователь, его пароль и имя будущей БД:
```
environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: 123456
            POSTGRES_DB: query_results_db
```
В подключаемых томах указаны sql скрипт создающий таблицу в БД и каталог в котором будет хранится база вне образа, чтобы не потерять историю запросов при отключении контейнера.
```
volumes:
            - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
            - ./dbDir:/var/lib/postgresql/data
```

### Хранение модели и подключение Volume

В Docker нельзя хранить данные, т.к. они исчезнут, как только контейнер будет остановлен.
Модели машинного обучения приходится хранить за пределами Docker из-за их большого размера, чтобы не увеличивать размер входящих в образ компонентов, и как следствие не замедлять скорость сборки и работы.
По этому к образу Docker подключается внешний том(Volume) для хранения данных.
В моём случае это был каталог, указанный в yml файле. Создадим папку models в каталоге с проектом и получим подобный путь:
```
$ mkdir models
$ cd models
$ pwd
/home/tim/ws_ft_cd/models
```
Полученный путь внесём в yam файл. В левую часть от символа ":".
```
volumes:
            - /home/tim/ws_ft_cd/models:/opt/fastText
```
Правая часть - это каталог внутри Docker, который будет соответствовать подключенному нами каталогу. Его менять не надо.

### Настройка Dockerfile

Переходим к настройке Dockerfile в каталоге project. Его содержимое должно выглядеть примерно следующим образом:
```
$ ll -h
./
../
Dockerfile          - Файл с настройками Docker контейнера. Можно не трогать, если вы не меняли расположение Volume внутри Docker.
requirements.txt    - содержит необходимые для проекта python-зависимости, указанные выше.
web/                - Каталог с скриптами и шаблонами для web-сервиса.
```

## Настройка web-сервиса

Последним этапом настройки является файл конфигурации config.py, который содержит:
* ключ для защиты от CSRF-атаки.
* Настройки пагинации - количество запросов одновременно отображаемых в ответе при обращении к страницам "/history" и "/similarities" методом GET
* Параметры подключения к БД (изменить на свои при необходимости)
Адрес хоста можно получить вызвав команду $ ifconfig
```
enp0s3    Link encap:Ethernet  HWaddr 08:00:27:1b:ea:a1  
          inet addr:10.0.2.15  Bcast:10.0.2.255  Mask:255.255.255.0
``` 

## Запуск и использование

Переходим в каталог ~/ws_ft_cd, где расположен файл docker-compose.yml и выполняем команду:
```
$ sudo docker-compose up
```
Открываем в браузере указанный адрес http://0.0.0.0:5000/ или http://127.0.0.1:5000/ пользуемся сервисом.

Полная сборка и запуск могут занять некоторое время, т.к. будут загружаться и устанавливаться некоторые зависимости, а также сразу произойдёт загрузка модели fastText, чтобы не загружать её на каждый запрос.

### Примеры curl запросов
* curl -X POST -F 'text1=пост запрос' -F 'text2=создаст новую запись' http://127.0.0.1:5000/similarities
* curl -X PUT -F 'text1=пут запрос изменит запись' -F 'text2=идентификатор которой указан после слеша' http://127.0.0.1:5000/similarities/4
* curl -X DELETE http://127.0.0.1:5000/similarities/4

